# Docker-malware-static-analysis
malware static detecion in docker based on API sequences
## 作者
    王玉龙 中国工程物理研究院计算机应用研究所/四川大学网络空间安全研究院
    email：wangyulong@caep.cn

## 1、文件说明

    api_static_detect.py:是结合容器elf获取和检测的整体封装程序
    treelib: 是为了可视elf函数结构，使用的一个python库
    ContainerELFApiStatic.py: 获取容器内elf并用angr分析的主体程序，集成中使用
    ContainerELFApiStatic-train.py: 是和容器无关的，建模时angr分析elf文件的主体程序
    Runs:目录中保存训练好的模型
    

## 2、使用


  2.1 异常检测
  
 配置 :
 
     安装angr和tensorflow
        
 首先进入treelib目录:
 
    python setup.py install
    
然后回到主目录:

    python api_static_detect.py -c 容器id -d 目录名（如果测试，目录中不要放太多二进制程序，分析时间会太长）
    
效果：
      
  在当前目录中新建了result目录，该目录中有对应每个elf的用于检测的api文件（过滤了UnresolvableTarget）和中间处理结果文件
  
      *info为：elf文件的节点编号ID和对应的函数属性，*map：程序中每个函数内部的调用关系子图）
      
  ![Fig 1](https://github.com/aisthebest/Docker-malware-static-analysis/blob/main/api_static_detect/Fig1.jpg)
  
  
  新建了容器id.log文件和_angr_error.log文件:
  
    容器id.log记录了路径太短（具体长度可在ContainerELFApiStatic.py中设置）
    
    angr分析结果，其中路径太短和分析失败的都不会在result中有对应的api文件，即不参与后续模型测试。
    
   ![Fig 2](https://github.com/aisthebest/Docker-malware-static-analysis/blob/main/api_static_detect/Fig2.jpg)

    _angr_error.log记录了angr分析失败的原因：
    
   ![Fig 3](https://github.com/aisthebest/Docker-malware-static-analysis/blob/main/api_static_detect/Fig3.jpg)


检测结束后，会在当前目录生成detect_malware 和detect_normal两个文件，分别记录检测出的恶意软件和正常软件。


## 3 建模数据获取

该部分作为扩充，待恶意样本和正常样本增多后可以重新进行训练学习，重构模型。

命令:

  python ContainerELFApiStatic-train.py 需要被分析的elf目录 分析结果文件 分析结果日志 elf文件标签
      
      如：python ContainerELFApiStatic-train.py normal/ traindata traindatalog
      
效果:

    在当前目录下新建一个分析结果文件traindata，该文件内存储了所有被分析elf的api结果，一行代表一个elf，其中过滤了None和UnresolvableTarget，但是路径太短的还是会输出，用于建模阶段。
    
    还会生成保存angr分析中间结果的result目录、分析结果日志文件traindatalog和错误日志文件_angr_error.log。
